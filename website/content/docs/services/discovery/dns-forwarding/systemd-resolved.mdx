---
layout: docs
page_title: DNS Forwarding with systemd-resolved
description: ->
  Learn how to configure your local systemd-resolved DNS server to perform DNS forwarding to Consul servers.
---

# DNS Forwarding with systemd-resolved



## Background

## Requirements

## DNS forwarding

You can use the [`systemd-resolved`](https://www.freedesktop.org/wiki/Software/systemd/resolved/) service to resolve local application names in your network. To use the service, configure `systemd-resolved` to send `.consul` domain queries to Consul by creating `consul.conf` file located in the /etc/systemd/resolved.conf.d/ directory.

<Tabs>
  <Tab heading="systemd 245 and older">


Add the following settings to your resolved configuration file:

<CodeBlockConfig filename="/etc/systemd/resolved.conf.d/consul.conf">

```ini
[Resolve]
DNS=127.0.0.1
DNSSEC=false
Domains=~consul
```

</CodeBlockConfig>

The main limitation with this configuration is that systemd 245 and older does not support configuring port numbers in the DNS field. You can either [configure Consul to listen on port 53](/consul/docs/agent/config/config-files#dns_port)
instead of 8600, or map port 53 to 8600 using `iptables`.

Binding to port 53 usually requires running `systemd-resolved` as a privileged user or running Linux with the
CAP_NET_BIND_SERVICE capability. If you are using the Consul Docker image, then you will need to add the following to the environment to allow Consul to use the port: `CONSUL_ALLOW_PRIVILEGED_PORTS=yes`

The following `iptables` commands are sufficient to map the ports.

```shell-session
iptables --table nat --append OUTPUT --destination localhost --protocol udp --match udp --dport 53 --jump REDIRECT --to-ports 8600
iptables --table nat --append OUTPUT --destination localhost --protocol tcp --match tcp --dport 53 --jump REDIRECT --to-ports 8600
```

~> The above configuration assumes Consul's DNS server is listening on the loopback
address. If Consul is not listening on the loopback IP, replace the references
to 'localhost' and '127.0.0.1' with the appropriate IP address for your environment.

</Tab>
<Tab heading="systemd 246 and newer">


If your distribution uses systemd 246 and newer, you can specify the DNS port directly in the `systemd-resolved` configuration file.
Previous versions of systemd required iptables rules to direct DNS traffic to Consul.

<CodeBlockConfig filename="/etc/systemd/resolved.conf.d/consul.conf">

```ini
[Resolve]
DNS=127.0.0.1:8600
DNSSEC=false
Domains=~consul
```

</CodeBlockConfig>

</Tab>
</Tabs>

<Note>

 PTR record queries will still be sent out to the other configured resolvers, in addition to Consul.

</Note>

After creating the resolved configuration, restart `systemd-resolved`.

```shell-session
# systemctl restart systemd-resolved
```

### Validate the systemd-resolved configuration

Validate that systemd-resolved has restarted and is configured to forward
queries to Consul.

```shell-session hideClipboard
# systemctl is-active systemd-resolved
active

# resolvectl domain
Global: ~consul
Link 2 (eth0):

# resolvectl query consul.service.consul
consul.service.consul: 127.0.0.1

-- Information acquired via protocol DNS in 6.6ms.
-- Data is authenticated: no
```

Confirm that `/etc/resolv.conf` points to the `stub-resolv.conf` file managed by
systemd-resolved, and that the IP address for systemd-resolved's stub resolver
is the configured `nameserver`.

<CodeBlockConfig hideClipboard highlight="1-2,4,21">

```shell-session
$ ls -l /etc/resolv.conf
lrwxrwxrwx 1 root root 37 Aug 20 22:50 /etc/resolv.conf -> /run/systemd/resolve/stub-resolv.conf

$ cat /etc/resolv.conf
# This file is managed by man:systemd-resolved(8). Do not edit.
#
# This is a dynamic resolv.conf file for connecting local clients to the
# internal DNS stub resolver of systemd-resolved. This file lists all
# configured search domains.
#
# Run "resolvectl status" to see details about the uplink DNS servers
# currently in use.
#
# Third party programs must not access this file directly, but only through the
# symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a different way,
# replace this symlink by a static file or a different symlink.
#
# See man:systemd-resolved.service(8) for details about the supported modes of
# operation for /etc/resolv.conf.

nameserver 127.0.0.53
options edns0
```

</CodeBlockConfig>

Ensure that the operating system can resolve DNS queries to the `.consul` domain.

```shell-session
$ host consul.service.consul
consul.service.consul has address 127.0.0.1
```

### Using any local resolver with systemd

By default, the local resolver stub in the `resolved.conf` file is configured to listen for UDP and TCP requests at 127.0.0.53:53, but you can set the `DNSStubListener` option to `false`, which disables the stub. As a result, your system will be able to use any DNS configuration as long as it loads earlier than `resolved`.

<CodeBlockConfig filename="/etc/systemd/resolved.conf">

```plaintext
DNSStubListener=false
```

</CodeBlockConfig>

Disabling the local resolver stub can also solve other DNS configuration issues. 


## Next steps
