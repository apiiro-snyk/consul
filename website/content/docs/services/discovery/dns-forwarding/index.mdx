---
layout: docs
page_title: DNS Forwarding
description: ->
  Learn how to configure your local DNS servers to perform DNS forwarding to Consul servers.
---

# DNS Forwarding

By default, DNS is served from port 53. On most operating systems, this
requires elevated privileges. Rather than running Consul with an administrative
or root account, you can forward appropriate queries to Consul (running on an unprivileged port) from another DNS server or port redirect.

## Background

You deployed a Consul datacenter and want to use Consul DNS interface for name resolution.

The operations perfomed in this guide can be applied for every node where a Consul agent is running.

![Consul DNS forwarding - All requests are routed to Consul](/img/consul-dns-forwarding.png)
![Consul DNS conditional forwarding - Only .consul requests are routed to Consul](/img/consul-dns-conditional-forwarding.png)


## Requirements

- A running Consul datacenter
- One or more services registered in the Consul datacenter

## DNS forwarding

There are many local DNS servers available. This guide provides steps for the most common ones:

- [systemd-resolved](/consul/docs/discovery/dns-forwarding/systemd-resolved)


### Query Consul DNS and BIND

First, add a service registration to your Consul agent. You can use the following example service configuration file and registration command.

<CodeBlockConfig filename="redis.json">

```json
{
  "service": {
    "name": "redis",
    "port": 80
  }
}
```

</CodeBlockConfig>

```shell-session
$ curl --data @redis.json http://127.0.0.1:8500/v1/catalog/register
```

To ensure that Consul DNS and your DNS server are configured correctly, use a `dig` query for the service you've registered.

```shell-session
$ dig @localhost -p 8600 primary.redis.service.dc1.consul. A
```

```plaintext hideClipboard
; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.23.rc1.32.amzn1 <<>> @localhost primary.redis.service.dc1.consul. A
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 11536
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;primary.redis.service.dc1.consul. IN A

;; ANSWER SECTION:
primary.redis.service.dc1.consul. 0 IN A 172.31.3.234

;; Query time: 4 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Wed Apr  9 17:36:12 2014
;; MSG SIZE  rcvd: 76
```

Next, run the same query against your BIND instance and make sure you get a
valid result:

```shell-session
$ dig @localhost -p 53 primary.redis.service.dc1.consul. A
```

```plaintext hideClipboard
; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.23.rc1.32.amzn1 <<>> @localhost primary.redis.service.dc1.consul. A
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 11536
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;primary.redis.service.dc1.consul. IN A

;; ANSWER SECTION:
primary.redis.service.dc1.consul. 0 IN A 172.31.3.234

;; Query time: 4 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Wed Apr  9 17:36:12 2014
;; MSG SIZE  rcvd: 76
```

If desired, verify reverse DNS using the same method:

```shell-session
$ dig @127.0.0.1 -p 8600 133.139.16.172.in-addr.arpa. PTR
```

```plaintext hideClipboard
; <<>> DiG 9.10.3-P3 <<>> @127.0.0.1 -p 8600 133.139.16.172.in-addr.arpa. PTR
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 3713
;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; WARNING: recursion requested but not available

;; QUESTION SECTION:
;133.139.16.172.in-addr.arpa.   IN  PTR

;; ANSWER SECTION:
133.139.16.172.in-addr.arpa. 0  IN  PTR consul1.node.dc1.consul.

;; Query time: 3 msec
;; SERVER: 127.0.0.1#8600(127.0.0.1)
;; WHEN: Sun Jan 31 04:25:39 UTC 2016
;; MSG SIZE  rcvd: 109
```

```shell-session
$ dig @127.0.0.1 -p 8600 +short -x 172.16.139.133
consul1.node.dc1.consul.
```

## Troubleshooting

If you don't get an answer from your DNS server (e.g., BIND, Dnsmasq) but you do get an answer from Consul, turn on your DNS server's query log to check for errors.

For BIND:

```shell-session
rndc querylog
tail -f /var/log/messages
```

The log may show errors like this:

```plaintext hideClipboard
error (no valid RRSIG) resolving
error (no valid DS) resolving
```

This indicates that DNSSEC is not disabled properly.

If you see errors about network connections, verify that there are no firewall
or routing problems between the servers running BIND and Consul.

For Dnsmasq, see the `log-queries` configuration option and the `USR1`
signal.

DNS forwarding may fail if you use the default `systemd-resolved` configuration and attempt to bind to 0.0.0.0. The default configuration uses a DNS stub that listens for UDP and TCP requests at 127.0.0.53. As a result, attempting to bind to 127.0.0.53 conflicts with the running stub. You can disable the stub as described in the [Using any local resolver with systemd](#using-any-local-resolver-with-systemd) section to troubleshoot this problem.

## Next steps

In this tutorial, you configured DNS forwarding for Consul DNS and your DNS server. Now that you have configured your environment, you can start using Consul for service discovery or service mesh.

- Ensure only [healthy service instances](/consul/tutorials/developer-discovery/service-registration-health-checks) are available in Consul DNS.
- Deploy services into a [zero trust network](/consul/tutorials/developer-mesh/service-mesh-with-envoy-proxy) with Consul service mesh.


