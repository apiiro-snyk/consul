---
layout: docs
page_title: DNS forwarding
description: ->
  Learn how to configure your local DNS servers to perform DNS forwarding to Consul servers.
---

# DNS forwarding

By default, DNS is served from port 53. On most operating systems, this requires elevated privileges. Rather than running Consul with an administrative
or root account, you can forward appropriate queries to Consul, running on an unprivileged port, from another DNS server or port redirect.

## Introduction

You deployed a Consul datacenter and want to use Consul DNS interface for name resolution.

The operations performed in this guide can be applied for every node where a Consul agent is running.

Consul does not resolve DNS records outside the `.consul.` zone by default. This means that, unless the [recursors](/consul/docs/agent/config/config-files#recursors) configuration option has been set Consul can only be used in a conditional forwading configuration.  In this cenario, if a Consul DNS reply includes a `CNAME` record pointing outside the `.consul` top level domain (TLD), then the DNS reply will only include `CNAME` records by default. 

When `recursors` is set and the upstream resolver is functioning correctly, Consul will try to resolve CNAMEs and include any records (e.g., A, AAAA, PTR) for them in its DNS reply. In these scenarios, Consul can be used for full DNS forwarding and is able to serve queries for all domains.

<Tabs>
<Tab heading="DNS forwarding" group="dns-forwarding">

![Consul DNS forwarding - All requests are routed to Consul](/img/consul-dns-forwarding.png)

</Tab>
<Tab heading="Conditional forwading" group="conditional-forwarding">

![Consul DNS conditional forwarding - Only .consul requests are routed to Consul](/img/consul-dns-conditional-forwarding.png)

</Tab>
</Tabs>

## Workflow

To use DNS forwarding in Consul deployments, complete the following steps:

1. Configure the local DNS service to enable DNS forwarding. Follow the instructions for one of the following services:
  
    - [systemd-resolved](/consul/docs/services/discovery/dns-forwarding/enable#systemd-resolved)
    - [BIND](/consul/docs/services/discovery/dns-forwarding/enable#bind)
    - [dnsmasq](/consul/docs/services/discovery/dns-forwarding/enable#dnsmasq)
    - [Unbound](/consul/docs/services/discovery/dns-forwarding/enable#unbound)
    - [iptables](/consul/docs/services/discovery/dns-forwarding/enable#iptables)
    - [macOS](/consul/docs/services/discovery/dns-forwarding/enable#macOS)

1. Query the Consul DNS to confirm that DNS forwarding functions correctly.

    ```shell-session
    dig consul.service.consul A
    
    ; <<>> DiG 9.16.48-Debian <<>> consul.service.consul A
    ;; global options: +cmd
    ;; Got answer:
    ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 51736
    ;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1
    
    ;; OPT PSEUDOSECTION:
    ; EDNS: version: 0, flags:; udp: 65494
    ;; QUESTION SECTION:
    ;consul.service.consul.		IN	A
    
    ;; ANSWER SECTION:
    consul.service.consul.	0	IN	A	10.0.4.140
    consul.service.consul.	0	IN	A	10.0.4.121
    consul.service.consul.	0	IN	A	10.0.4.9
    
    ;; Query time: 4 msec
    ;; SERVER: 127.0.0.53#53(127.0.0.53)
    ;; WHEN: Wed Jun 26 20:47:05 UTC 2024
    ;; MSG SIZE  rcvd: 98
    
    ```

1. Optionally, verify reverse DNS:

    ```shell-session
    $ dig 140.4.0.10.in-addr.arpa. PTR
    
    ; <<>> DiG 9.16.48-Debian <<>> 140.4.0.10.in-addr.arpa. PTR
    ;; global options: +cmd
    ;; Got answer:
    ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 35085
    ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
    
    ;; OPT PSEUDOSECTION:
    ; EDNS: version: 0, flags:; udp: 65494
    ;; QUESTION SECTION:
    ;140.4.0.10.in-addr.arpa.	IN	PTR
    
    ;; ANSWER SECTION:
    140.4.0.10.in-addr.arpa. 0	IN	PTR	consul-server-0.node.dc1.consul.
    
    ;; Query time: 0 msec
    ;; SERVER: 127.0.0.53#53(127.0.0.53)
    ;; WHEN: Wed Jun 26 20:47:57 UTC 2024
    ;; MSG SIZE  rcvd: 97
    
    ```
    
    You can use the `short` option for `dig` to only get the node name instead of the full output.

    ```shell-session
    $ dig +short -x 10.0.4.140
    consul-server-0.node.dc1.consul.
    ```

## Troubleshooting

If your DNS server does not respond but you do get an answer from Consul, turn on your DNS server's query log to check for errors.

For BIND:

```shell-session
rndc querylog
tail -f /var/log/messages
```

The log may show errors like this:

```plaintext hideClipboard
error (no valid RRSIG) resolving
error (no valid DS) resolving
```

This indicates that DNSSEC is not disabled properly.

If you see errors about network connections, verify that there are no firewall
or routing problems between the servers running BIND and Consul.

For Dnsmasq, see the `log-queries` configuration option and the `USR1`
signal.

DNS forwarding may fail if you use the default `systemd-resolved` configuration and attempt to bind to 0.0.0.0. The default configuration uses a DNS stub that listens for UDP and TCP requests at 127.0.0.53. As a result, attempting to bind to 127.0.0.53 conflicts with the running stub. You can disable the stub as described in the [Using any local resolver with systemd](#using-any-local-resolver-with-systemd) section to troubleshoot this problem.

## Next steps

In this tutorial, you configured DNS forwarding for Consul DNS and your DNS server. Now that you have configured your environment, you can start using Consul for service discovery or service mesh.

- Ensure only [healthy service instances](/consul/tutorials/developer-discovery/service-registration-health-checks) are available in Consul DNS.
- Deploy services into a [zero trust network](/consul/tutorials/developer-mesh/service-mesh-with-envoy-proxy) with Consul service mesh.
